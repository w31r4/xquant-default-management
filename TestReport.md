# 项目测试通过报告

## 1. 测试综述

本项目采用**测试金字塔**模型，通过单元测试、集成测试和端到端测试，确保了系统的稳定性和可靠性。所有核心功能模块均已通过测试，覆盖了从底层工具函数到完整业务流程的各个层面。

**测试结果**: 所有测试用例均已通过。

## 2. 测试环境

- **Go 版本**: `go version go1.22.4 linux/amd64`
- **依赖管理**: Go Modules
- **数据库**: PostgreSQL (通过 Docker Compose 启动)

## 3. 单元测试详情

### 3.1. `utils` 包

#### 3.1.1. `crypto.go`

- **测试用例**:
    - `TestHashPassword`: 验证密码能否被成功哈希，并且哈希后的值与原密码不同。
    - `TestCheckPasswordHash`: 验证哈希后的密码能否与原密码正确匹配，以及与错误密码不匹配。

#### 3.1.2. `jwt.go`

- **测试用例**:
    - `TestGenerateAndValidateToken`: 验证 JWT 能否被成功生成和解析，且解析出的用户信息正确。
    - `TestValidateTokenInvalidSignature`: 验证使用错误密钥签名的 JWT 会被拒绝。
    - `TestValidateTokenExpired`: 验证已过期的 JWT 会被拒绝。

### 3.2. `repository` 层

- **测试方法**: 使用 `go-sqlmock` 模拟数据库操作。
- **测试用例**:
    - `TestUserRepository_Create`: 验证用户数据能否被正确地插入数据库。
    - `TestUserRepository_GetByUsername`: 验证能否根据用户名成功查询到用户，以及查询不到用户时返回 `ErrRecordNotFound`。

### 3.3. `service` 层

- **测试方法**: 使用 `mockery` 生成 `repository` 的 mock 实现。
- **测试用例**:
    - **用户注册**:
        - **成功场景**: 新用户成功注册。
        - **失败场景**: 用户名已存在；数据库查询或创建失败。
    - **用户登录**:
        - **成功场景**: 用户凭证正确，成功返回 JWT。
        - **失败场景**: 用户不存在；密码错误；数据库查询失败。

### 3.4. `handler` 层

- **测试方法**: 使用 `httptest` 模拟 HTTP 请求。
- **测试用例**:
    - **用户注册 (`/register`)**:
        - **成功**: 返回 `201 Created`。
        - **失败**: 请求体格式错误 (`400 Bad Request`)；用户名冲突 (`409 Conflict`)；服务器内部错误 (`500 Internal Server Error`)。
    - **用户登录 (`/login`)**:
        - **成功**: 返回 `200 OK` 及 JWT。
        - **失败**: 凭证无效 (`401 Unauthorized`)。

### 3.5. `middleware` 层

- **测试用例**:
    - **AuthMiddleware**:
        - **成功**: 提供有效的 JWT，请求被成功处理。
        - **失败**: 未提供 `Authorization` 头；`Authorization` 头格式错误；JWT 无效或过期 (均返回 `401 Unauthorized`)。
    - **RBACMiddleware**:
        - **成功**: 用户角色符合要求，请求被成功处理。
        - **失败**: 用户角色不符；上下文中无角色信息 (均返回 `403 Forbidden`)。

## 4. 集成测试详情

- **测试场景**:
    - **用户注册与登录**: 验证 `UserService` 和 `UserRepository` 在真实数据库环境下的协同工作。确保用户注册后，数据能被正确写入数据库，并且该用户能成功登录。

## 5. 端到端测试详情

- **业务流程**: 注册 -> 登录 -> 创建申请 -> 审批
- **测试步骤**:
    1.  **注册**: 创建一个“申请人”和一个“审批人”用户。
    2.  **登录**: “申请人”登录，获取 JWT。
    3.  **创建申请**: “申请人”使用 JWT 调用接口，成功创建一个申请。
    4.  **审批人登录**: “审批人”登录，获取 JWT。
    5.  **获取待办**: “审批人”调用接口，成功获取待处理的申请列表。
    6.  **审批**: “审批人”调用接口，成功批准该申请。
    7.  **验证状态**: 检查数据库，确认申请状态已更新为“Approved”。

## 6. 总结

本项目已建立了一套全面的、多层次的自动化测试体系。所有核心功能均被单元测试、集成测试和端到端测试覆盖，为项目的稳定性和未来的迭代开发提供了坚实的保障。