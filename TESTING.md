# 项目测试报告

本文档详细介绍了本项目的测试策略、测试方法以及如何复现所有测试。

## 1. 测试策略概述

我们采用了经典的“测试金字塔”模型，以确保项目的稳定性和可靠性。测试分为三个主要层级：

- **单元测试 (Unit Tests)**：构成了测试金字塔的基础，用于隔离和验证最小的功能单元。
- **集成测试 (Integration Tests)**：测试多个组件协同工作的场景。
- **端到端测试 (E2E Tests)**：模拟真实用户请求，完整地测试整个系统。

目前，我们已经完成了所有核心功能模块的单元测试、集成测试和端到端测试。

## 2. 单元测试

### 2.1. 目标

单元测试的目标是确保每个独立的组件（例如，一个函数或一个方法）在隔离的环境中都能按预期工作。这有助于快速定位和修复 bug，并为代码重构提供安全保障。

### 2.2. 测试方法与覆盖范围

我们为以下每个层级都编写了全面的单元测试：

- **`utils` 包**：
  - **方法**：直接测试每个工具函数（如密码哈希、JWT 生成与验证）的输入和输出。
  - **覆盖范围**：`crypto.go`, `jwt.go`

- **`repository` 层**：
  - **方法**：使用 `go-sqlmock` 库来模拟数据库连接和 SQL 查询。这使我们能够在不依赖真实数据库的情况下，精确地验证仓储层的数据操作逻辑。
  - **覆盖范围**：`user_repository.go`

- **`service` 层**：
  - **方法**：使用 `mockery` 自动生成 `repository` 接口的 `mock` 实现。通过控制 `mock` 对象的行为，我们隔离了 `service` 层，并独立地测试了其业务逻辑。
  - **覆盖范围**：`user_service.go`

- **`handler` 层**：
  - **方法**：使用 `httptest` 来模拟 HTTP 请求和响应。同时，使用 `mockery` 生成的 `service` 接口的 `mock` 实现来隔离 `handler` 层，重点测试其请求处理、参数绑定和响应生成的逻辑。
  - **覆盖范围**：`user_handler.go`

- **`middleware` 层**：
  - **方法**：与 `handler` 层类似，使用 `httptest` 来模拟 HTTP 请求，并验证中间件是否能正确地处理请求、修改上下文以及执行访问控制。
  - **覆盖范围**：`auth_middleware.go`, `rbac_middleware.go`

### 2.3. 如何复现测试

#### 准备工作

在运行测试之前，请确保所有依赖项都已正确安装：

```bash
go mod tidy
```

#### 运行所有单元测试

要运行项目中的所有单元测试，请在项目根目录下执行以下命令：

```bash
go test ./...
```

#### 运行特定包的测试

您也可以只运行特定包的测试。例如，要只运行 `repository` 层的测试，请执行：

```bash
go test ./internal/repository
```

将 `repository` 替换为您想测试的包名即可（例如 `utils`, `service`, `handler`, `middleware`）。

## 3. 集成测试与端到端测试

我们已经为项目编写了完整的集成测试和端到端测试，它们位于 `integration` 目录下。

### 3.1. 目标

- **集成测试**：验证服务层与仓储层的协同工作，确保业务逻辑在与真实数据库交互时能够正确执行。
- **端到端测试**：模拟真实用户的完整操作流程，验证整个系统（从 API 端点到数据库）的正确性和健壮性。

### 3.2. 如何复现测试

#### 准备工作：启动测试数据库

在运行集成测试之前，您需要一个正在运行的 PostgreSQL 实例。我们已经通过 Docker Compose 为您准备好了一个测试环境。请在项目根目录下执行以下命令来启动它：

```bash
docker compose -f docker-compose.test.yml up -d
```

这个命令会启动一个独立的 PostgreSQL 数据库容器，专门用于测试，不会影响您的开发数据库。

#### 运行测试

当测试数据库正在运行时，执行以下命令来运行所有的集成和端到端测试：

```bash
go test ./integration
```

这个命令会自动连接到测试数据库，并执行 `integration` 目录下的所有测试，包括：
- 服务层与仓储层的集成测试。
- 完整的端到端业务流程测试（注册 -> 登录 -> 创建申请 -> 审批）。

#### 清理环境

测试完成后，您可以使用以下命令来关闭并移除测试数据库容器：

```bash
docker compose -f docker-compose.test.yml down
```

## 4. 总结

我们已经为项目建立了一个坚实的、多层次的测试基础，覆盖了所有核心的业务逻辑和功能模块。这为项目的未来发展和维护提供了有力的保障。